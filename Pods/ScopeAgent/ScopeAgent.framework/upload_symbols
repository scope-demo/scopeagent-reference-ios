#!/bin/sh

if [ -z "${SCOPE_APIKEY}" ] || [ -z "${SCOPE_API_ENDPOINT}" ]; then
  echo "No \$SCOPE_APIKEY or \$SCOPE_API_ENDPOINT detected - skipping symbol file upload to Scope"
  exit 0
fi
searchdir=${BUILD_DIR}

if [ -z "$(find ${searchdir} -name '*.dSYM')" ]; then
  echo "No .dSYM files found in ${searchdir} - skipping symbol file upload to Scope"
  exit 0
fi

tmpdir=$(mktemp -d)
tmpfile="${tmpdir}/symbols.zip"
find ${searchdir} -name "*.dSYM" | zip -q -@ -r ${tmpfile}

echo "Uploading .dSYM files to ${SCOPE_API_ENDPOINT}"
curl -Ssf --retry 4 --retry-delay 5 -F "file=@${tmpfile};type=application/zip" -H "X-Scope-ApiKey: ${SCOPE_APIKEY}" ${SCOPE_API_ENDPOINT}/api/agent/upload
if [ $? != 0 ]; then
  echo "Something failed when uploading .dSYM files to ${SCOPE_API_ENDPOINT}"
else
  echo "Symbol files successfully uploaded to ${SCOPE_API_ENDPOINT}"
fi

rm -r ${tmpdir}
